name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Backend CI"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    env:
      STAGING_HOST: ${{ secrets.STAGING_HOST }}
      STAGING_USER: ${{ secrets.STAGING_USER }}
      STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
      STAGING_DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
      DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
      IMAGE_NAME: ${{ github.repository }}
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "$STAGING_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo -e "Host staging\n\tHostName $STAGING_HOST\n\tUser $STAGING_USER\n\tIdentityFile ~/.ssh/id_rsa\n\tStrictHostKeyChecking=no" >> ~/.ssh/config

      - name: Pull Docker Image on Staging Server
        run: |
          ssh staging "docker login $DOCKER_REGISTRY -u '${{ secrets.DOCKER_USERNAME }}' -p '${{ secrets.DOCKER_PASSWORD }}'"
          ssh staging "docker pull $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG"

      - name: Copy docker-compose.yml to staging
        run: |
          scp backend/deploy/docker-compose.staging.yml staging:/home/$STAGING_USER/docker-compose.yml

      - name: Run DB migrations on Staging
        run: |
          ssh staging "
            docker run --rm \
              -e DATABASE_URL='$STAGING_DATABASE_URL' \
              $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
              npm run migrate
          "

      - name: Deploy New Container (Zero Downtime)
        run: |
          ssh staging "
            cd ~/ ;
            docker compose down ;
            docker compose up -d ;
          "

      - name: Smoke Test â€” Health Check
        run: |
          sleep 5
          curl -f https://$STAGING_HOST/api/health || exit 1

      - name: Deployment successful
        run: echo "Staging deployment completed successfully"
