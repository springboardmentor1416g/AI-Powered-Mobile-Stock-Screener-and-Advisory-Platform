{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["filter"],
  "properties": {
    "filter": { "$ref": "#/definitions/logicalNode" },
    "meta": {
      "type": "object",
      "additionalProperties": { "type": "string" }
    }
  },

  "definitions": {
    "logicalNode": {
      "oneOf": [
        { "$ref": "#/definitions/andNode" },
        { "$ref": "#/definitions/orNode" },
        { "$ref": "#/definitions/notNode" },
        { "$ref": "#/definitions/condition" }
      ]
    },

    "andNode": {
      "type": "object",
      "required": ["and"],
      "properties": {
        "and": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/logicalNode" }
        }
      },
      "additionalProperties": false
    },

    "orNode": {
      "type": "object",
      "required": ["or"],
      "properties": {
        "or": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/logicalNode" }
        }
      },
      "additionalProperties": false
    },

    "notNode": {
      "type": "object",
      "required": ["not"],
      "properties": {
        "not": { "$ref": "#/definitions/logicalNode" }
      },
      "additionalProperties": false
    },

    "condition": {
      "type": "object",
      "required": ["field", "operator"],
      "properties": {
        "field": { "type": "string" },
        "operator": {
          "enum": ["<", ">", "<=", ">=", "=", "!=", "between", "in", "exists"]
        },
        "value": {},
        "period": { "$ref": "#/definitions/period" },
        "derived_from": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    },

    "period": {
      "type": "object",
      "required": ["type", "n", "aggregation"],
      "properties": {
        "type": { "enum": ["last_n_quarters", "last_n_years"] },
        "n": { "type": "integer", "minimum": 1 },
        "aggregation": { "enum": ["all", "any", "avg", "sum"] }
      },
      "additionalProperties": false
    }
  }
}
