# DSL Validation Rules

**Module:** LLM Parser Service  
**Purpose:** Validate DSL output from LLM/stub against strict schema  
**Location:** `/backend/api-gateway/src/services/llm_parser/llmSchema.js`  

---

## Overview

The DSL Validation Rules ensure that all DSL queries generated by the LLM Parser are:
- ✅ **Safe** - No SQL injection or unauthorized field access
- ✅ **Deterministic** - Produce consistent, predictable results
- ✅ **Complete** - All required fields present and valid
- ✅ **Consistent** - Logical operators used correctly
- ✅ **Type-Safe** - Values match expected data types

---

## Validation Architecture

```
Natural Language Query
        ↓
    LLM/Stub Translation
        ↓
    DSL JSON Output
        ↓
┌───────────────────────┐
│  DSL VALIDATION       │
│  - Structure Check    │
│  - Field Whitelist    │
│  - Operator Rules     │
│  - Type Validation    │
│  - Logic Consistency  │
└───────────────────────┘
        ↓
    Validated DSL → Screener Compiler
```

---

## 1. Top-Level Structure Rules

### Required Properties
```json
{
  "filter": { ... }  // REQUIRED: Main filtering logic
}
```

### Optional Properties
```json
{
  "filter": { ... },
  "meta": { ... },      // OPTIONAL: Sector, exchange filters
  "limit": 100,         // OPTIONAL: Result limit (1-1000)
  "sort": { ... }       // OPTIONAL: Sort criteria
}
```

### Validation Rules
- ✅ `filter` property is **mandatory**
- ✅ Only allowed top-level keys: `filter`, `meta`, `limit`, `sort`
- ❌ No additional properties permitted
- ❌ DSL cannot be null or empty

---

## 2. Logical Expression Rules

### Structure
Logical expressions must contain **exactly one** of:
- `and` - All conditions must be true
- `or` - At least one condition must be true
- `not` - Negation of condition/expression

### AND/OR Rules
```json
{
  "and": [
    { "field": "pe_ratio", "operator": "<", "value": 15 },
    { "field": "roe", "operator": ">", "value": 15 }
  ]
}
```

**Validation:**
- ✅ Must be an array
- ✅ Array cannot be empty
- ✅ Can contain conditions OR nested logical expressions
- ❌ Cannot mix `and` and `or` at same level

### NOT Rules
```json
{
  "not": {
    "field": "debt_to_equity",
    "operator": ">",
    "value": 1
  }
}
```

**Validation:**
- ✅ Must contain single condition or expression
- ❌ Cannot be an array

### Nesting
```json
{
  "and": [
    { "field": "pe_ratio", "operator": "<", "value": 15 },
    {
      "or": [
        { "field": "roe", "operator": ">", "value": 15 },
        { "field": "roa", "operator": ">", "value": 10 }
      ]
    }
  ]
}
```

**Validation:**
- ✅ Unlimited nesting depth allowed
- ✅ Each nested level must follow logical expression rules

---

## 3. Allowed Fields (Whitelist)

### Valuation Metrics
```
pe_ratio, peg_ratio, price_to_book, price_to_sales, ev_to_ebitda
```

### Profitability Metrics
```
net_profit, ebitda, roe, roa, operating_margin, net_margin, 
revenue_growth_yoy, earnings_growth_yoy, eps_growth
```

### Debt & Liquidity Metrics
```
total_debt, free_cash_flow, debt_to_equity, debt_to_fcf, 
current_ratio, quick_ratio
```

### Ownership Metrics
```
promoter_holding, institutional_holding
```

### Market Metrics
```
market_cap, volume, dividend_yield, payout_ratio, earnings_yield, 
fcf_yield, price_change_from_52w_high, price_change_from_52w_low, beta
```

### Revenue & Profit Metrics
```
revenue, gross_profit, operating_profit
```

### Validation Rules
- ✅ Only fields from the whitelist are allowed
- ❌ Any other field name triggers validation error
- ❌ Field names are case-sensitive
- ℹ️ **Error Message:** `Unsupported field: "{field_name}". Allowed fields: ...`

---

## 4. Allowed Operators

### Comparison Operators
| Operator | Description | Example Value Type |
|----------|-------------|-------------------|
| `<` | Less than | `number` or `string` |
| `>` | Greater than | `number` or `string` |
| `<=` | Less than or equal | `number` or `string` |
| `>=` | Greater than or equal | `number` or `string` |
| `=` | Equal to | `number` or `string` |
| `!=` | Not equal to | `number` or `string` |
| `between` | Range (inclusive) | `[number, number]` |
| `in` | Set membership | `array` |
| `exists` | Null check | `boolean` |

### Validation Rules
- ✅ Only operators from the whitelist are allowed
- ❌ String operators like `"less than"` are not valid (must be `<`)
- ℹ️ **Error Message:** `Unsupported operator: "{operator}". Allowed operators: ...`

---

## 5. Condition Object Rules

### Required Properties
```json
{
  "field": "pe_ratio",    // REQUIRED
  "operator": "<",        // REQUIRED
  "value": 15            // REQUIRED (except for 'exists')
}
```

### Optional Properties
```json
{
  "field": "revenue_growth_yoy",
  "operator": ">",
  "value": 20,
  "period": {                    // OPTIONAL: Time constraint
    "type": "last_n_quarters",
    "n": 4,
    "aggregation": "all"
  },
  "derived_from": ["revenue"]    // OPTIONAL: Source fields for derived metrics
}
```

### Validation Rules
- ✅ `field`, `operator` are mandatory
- ✅ `value` is mandatory (except for `exists` operator)
- ✅ No additional properties allowed
- ❌ Cannot have empty field or operator

---

## 6. Value Validation by Operator

### Standard Comparison (`<`, `>`, `<=`, `>=`, `=`, `!=`)
```json
{
  "field": "pe_ratio",
  "operator": "<",
  "value": 15  // Must be number or string
}
```

**Rules:**
- ✅ Value must be `number` or `string`
- ❌ Cannot be `null`, `undefined`, `array`, or `object`

### Between Operator
```json
{
  "field": "roe",
  "operator": "between",
  "value": [10, 25]  // Must be array of exactly 2 numbers
}
```

**Rules:**
- ✅ Value must be array with exactly 2 numbers
- ✅ First value must be less than second value
- ❌ Cannot have more or fewer than 2 elements
- ❌ Both elements must be numbers

### In Operator
```json
{
  "field": "sector",
  "operator": "in",
  "value": ["IT", "Pharma", "Auto"]  // Non-empty array
}
```

**Rules:**
- ✅ Value must be a non-empty array
- ✅ Array can contain any valid values
- ❌ Cannot be empty array

### Exists Operator
```json
{
  "field": "dividend_yield",
  "operator": "exists",
  "value": true  // Must be boolean
}
```

**Rules:**
- ✅ Value must be boolean (`true` or `false`)
- ❌ Cannot be any other type

---

## 7. Time Period Validation

### Period Structure
```json
{
  "type": "last_n_quarters",    // REQUIRED
  "n": 4,                       // REQUIRED
  "aggregation": "all"          // REQUIRED
}
```

### Allowed Period Types
```
last_n_quarters
last_n_years
trailing_12_months
```

### Allowed Aggregations
| Aggregation | Description |
|-------------|-------------|
| `all` | All periods must satisfy condition |
| `any` | At least one period must satisfy |
| `avg` | Average across periods |
| `sum` | Sum across periods |
| `min` | Minimum across periods |
| `max` | Maximum across periods |

### Validation Rules
- ✅ `type` must be from allowed period types
- ✅ `n` must be integer between 1 and 20
- ✅ `aggregation` must be from allowed aggregations
- ❌ No additional properties allowed

---

## 8. Metadata Validation

### Allowed Metadata Properties
```json
{
  "sector": "IT",                          // Optional: Industry sector
  "exchange": "NSE",                       // Optional: Stock exchange
  "market_cap_category": "Large Cap",      // Optional: Market cap category
  "index": "NIFTY50",                      // Optional: Index membership
  "market_cap_range": {                    // Optional: Market cap range
    "min": 1000,
    "max": 100000
  }
}
```

### Exchange Validation
**Allowed Values:** `NSE`, `BSE`, `NYSE`, `NASDAQ`

### Market Cap Category Validation
**Allowed Values:** `Large Cap`, `Mid Cap`, `Small Cap`, `Micro Cap`

### Validation Rules
- ✅ All metadata properties are optional
- ✅ Only allowed metadata keys permitted
- ❌ Invalid exchange or market_cap_category values rejected

---

## 9. Sort Validation

### Sort Structure
```json
{
  "field": "pe_ratio",
  "order": "asc"
}
```

### Validation Rules
- ✅ `field` must be from allowed fields list
- ✅ `order` must be either `"asc"` or `"desc"`
- ❌ No other sort orders allowed

---

## 10. Common Validation Errors

### Error: Unsupported Field
```
Error: Unsupported field: "profit_margin". 
Allowed fields: pe_ratio, peg_ratio, price_to_book, ...
```

**Cause:** Field not in whitelist  
**Fix:** Use correct field name from catalog

### Error: Logical Expression Must Have One Operator
```
Error: Logical expression must have exactly one of: and, or, not
```

**Cause:** Multiple logical operators at same level or missing operator  
**Fix:** Use only one of `and`, `or`, or `not`

### Error: Value Type Mismatch
```
Error: Value for "between" operator must be an array of 2 numbers
```

**Cause:** Wrong value type for operator  
**Fix:** Match value type to operator requirements

### Error: Empty Array
```
Error: AND array cannot be empty
```

**Cause:** Logical operator has empty conditions array  
**Fix:** Add at least one condition

### Error: Invalid Period
```
Error: Period "n" must be a number between 1 and 20
```

**Cause:** Period parameter out of range  
**Fix:** Use valid period range

---

## 11. Validation Flow Diagram

```
DSL Input
    ↓
┌─────────────────────────┐
│ 1. Check Top-Level      │ → Verify filter, meta, limit, sort
└─────────────────────────┘
    ↓
┌─────────────────────────┐
│ 2. Validate Filter      │ → Check logical expression structure
└─────────────────────────┘
    ↓
┌─────────────────────────┐
│ 3. Validate Conditions  │ → Check each condition
└─────────────────────────┘
    ↓
┌─────────────────────────┐
│ 4. Check Fields         │ → Verify against whitelist
└─────────────────────────┘
    ↓
┌─────────────────────────┐
│ 5. Check Operators      │ → Verify against allowed list
└─────────────────────────┘
    ↓
┌─────────────────────────┐
│ 6. Validate Values      │ → Type check based on operator
└─────────────────────────┘
    ↓
┌─────────────────────────┐
│ 7. Validate Period      │ → Check time constraints (if present)
└─────────────────────────┘
    ↓
┌─────────────────────────┐
│ 8. Validate Metadata    │ → Check optional filters
└─────────────────────────┘
    ↓
    ✅ Valid DSL → Forward to Compiler
    ❌ Invalid DSL → Return Error
```

---

## 12. Security Considerations

### SQL Injection Prevention
- ✅ No raw SQL strings allowed in DSL
- ✅ All fields validated against whitelist
- ✅ All operators validated against whitelist
- ✅ Values are typed and sanitized

### Unauthorized Field Access
- ✅ Only pre-approved financial metrics accessible
- ✅ Database column names never exposed to user
- ✅ Field mapping handled by compiler, not DSL

### Denial of Service Prevention
- ✅ Result limit capped at 1000
- ✅ Period range limited to 1-20
- ✅ Nesting depth unlimited but monitored

---

## 13. Usage Example

### Valid DSL
```json
{
  "filter": {
    "and": [
      {
        "field": "pe_ratio",
        "operator": "<",
        "value": 15
      },
      {
        "field": "roe",
        "operator": ">",
        "value": 15,
        "period": {
          "type": "last_n_quarters",
          "n": 4,
          "aggregation": "all"
        }
      }
    ]
  },
  "meta": {
    "sector": "IT",
    "exchange": "NSE"
  },
  "limit": 50,
  "sort": {
    "field": "market_cap",
    "order": "desc"
  }
}
```

**Validation Result:** ✅ **PASS** - All rules satisfied

### Invalid DSL
```json
{
  "filter": {
    "and": [
      {
        "field": "profit_margin",  // ❌ Not in whitelist
        "operator": "less than",   // ❌ Invalid operator format
        "value": "15%"             // ❌ Should be number, not string with %
      }
    ]
  }
}
```

**Validation Result:** ❌ **FAIL**
```
Error: Unsupported field: "profit_margin"
```

---

## 14. References

- **DSL Specification:** `/engine/dsl/DSL_SPECIFICATION.md`
- **Field Catalog:** `/engine/dsl/field_catalog.json`
- **JSON Schema:** `/engine/dsl/schema.json`
- **Validation Implementation:** `/backend/api-gateway/src/services/llm_parser/llmSchema.js`

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-26 | Initial validation rules documentation |
